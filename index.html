<script>
// CONFIG
const SMARTLINK = "https://harbourbreederdump.com/an29v43y4m?key=549781a632ef3b8389ad01c914a1ee3a";

const q = new URLSearchParams(location.search);
const vidId = q.get('id') || q.get('v') || '';
const dmId = q.get('dm');
const rawSrc = q.get('src');

const galleryPage = document.getElementById('galleryPage');
const playerPage = document.getElementById('playerPage');
const shell = document.getElementById('shell');
const vid = document.getElementById('vid');
const frame = document.getElementById('frame');
const overlay = document.getElementById('overlay');

// ROUTING
if(vidId || dmId || rawSrc) {
  galleryPage.style.display = 'none';
  playerPage.style.display = 'block';
  initPlayer();
} else {
  loadVideosFromTxt();
}

function goHome(){ window.location.href = window.location.pathname; }

// LOAD FROM TXT (DIPERBAIKI)
async function loadVideosFromTxt() {
  const statusMsg = document.getElementById('statusMsg');
  const target = document.getElementById('gridTarget');
  
  try {
    // TAMBAHAN: '?t=' + Date.now() berguna untuk memaksa browser mengambil data terbaru (bypass cache)
    const response = await fetch('videos.txt?t=' + Date.now());
    
    if(!response.ok) { 
      statusMsg.textContent = "Gagal memuat: videos.txt tidak ditemukan (404).";
      statusMsg.style.color = "red";
      return; 
    }
    
    const textData = await response.text();
    const lines = textData.split('\n');
    let html = '';
    let count = 0;

    lines.forEach(line => {
      if(!line.trim()) return;
      const parts = line.split('|');
      const id = parts[0].trim();
      const title = parts[1] ? parts[1].trim() : 'Video Tanpa Judul';
      
      if(id) {
        count++;
        // Logika Badge
        let badgeType = "VIDEY";
        if(id.length > 8 || (isNaN(id.charAt(0)) && id.length > 7)) { 
             if(id.length > 8) badgeType = "DM"; 
        }

        html += `
        <a href="?id=${id}" class="vid-card">
          <div class="thumb-area">
            <div class="play-icon-small">
              <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </div>
          </div>
          <div class="card-info">
            <div class="badge-row">
              <span class="src-badge">${badgeType}</span>
            </div>
            <p class="vid-title">${title}</p>
          </div>
        </a>
        `;
      }
    });

    if(count > 0){
      target.innerHTML = html;
      statusMsg.style.display = 'none';
    } else {
      statusMsg.textContent = "File videos.txt kosong atau format salah.";
    }
  } catch (error) {
    // TAMPILKAN ERROR DI LAYAR
    console.error(error);
    statusMsg.textContent = "Error System: " + error.message;
    statusMsg.style.color = "red";
  }
}

// PLAYER LOGIC
function initPlayer(){
  let srcUrl = '';
  document.getElementById('dlBtn').onclick = () => { if(SMARTLINK) window.open(SMARTLINK, '_blank'); };

  if(dmId){
    setupIframe(`https://www.dailymotion.com/embed/video/${dmId}?autoplay=1&mute=1`, '16/9');
    return;
  }

  if(vidId){
    if(vidId.length > 10 || vidId.startsWith('k')) {
       setupIframe(`https://www.dailymotion.com/embed/video/${vidId}?autoplay=1&mute=1`, '16/9');
       return;
    }
    srcUrl = `https://cdn.videy.co/${vidId}.mp4`;
    document.getElementById('vidTitle').textContent = `Now Playing`;
  } else if(rawSrc){ srcUrl = rawSrc; }

  if(srcUrl){
    vid.src = srcUrl;
    vid.load();
    vid.onloadedmetadata = function() {
      const w = this.videoWidth; const h = this.videoHeight;
      if(w && h) shell.style.aspectRatio = (h > w) ? `${w}/${h}` : `${w}/${h}`;
      if(h > w) shell.classList.add('vertical');
    };
    vid.muted = true;
    vid.play().catch(()=>{});
  }
}

function setupIframe(url, ratio){
  shell.style.aspectRatio = ratio;
  frame.src = url;
  frame.style.display = 'block';
  vid.style.display = 'none';
  overlay.style.display = 'none';
}

document.getElementById('playTrigger').onclick = () => {
  if(SMARTLINK) window.open(SMARTLINK, '_blank');
  overlay.style.opacity = '0';
  setTimeout(()=> overlay.style.display='none', 300);
  if(vid.style.display !== 'none'){ vid.muted = false; vid.play(); }
};
</script>